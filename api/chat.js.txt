import { initializeApp } from "firebase/app";
import { getDatabase, ref, push, set, serverTimestamp } from "firebase/database";

const firebaseConfig = {
  apiKey: "AIzaSyBqe8RORo6cFifF1aU05eEGRcyafjsH2hU",
  authDomain: "whispeer-81650.firebaseapp.com",
  databaseURL: "https://whispeer-81650-default-rtdb.firebaseio.com/",
  projectId: "whispeer-81650",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  try {
    const { text, nickname } = req.body;
    if (!text || text.trim().length === 0) {
      return res.status(400).json({ error: "Empty message" });
    }

    const chatRef = ref(db, "chats");
    const newMsgRef = push(chatRef);
    await set(newMsgRef, {
      nickname: nickname || "anon",
      text: text.trim(),
      createdAt: serverTimestamp(),
    });

    res.status(200).json({ success: true });
  } catch (e) {
    console.error("Chat error:", e);
    res.status(500).json({ error: "Server error" });
  }
}
